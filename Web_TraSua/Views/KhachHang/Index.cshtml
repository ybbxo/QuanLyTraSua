@model IEnumerable<WebTraSua.Models.KhachHang>
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Quản lý khách hàng";
    var searchText = Context.Request.Query["search"].ToString();
    var role = Context.Session.GetString("Role");
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "");
    string Active(string c) => string.Equals(ctrl, c, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    var adminCtrls = new HashSet<string> { "QuanLy", "DanhMuc", "SanPham", "QuanLyDonHang", "NguyenLieuQuanLy", "NhapKho", "ThongKe", "KhachHang", "BinhLuan" ,"TonKho"};
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<div class="container-fluid py-4">
    <div class="row">
        @if (role == "QuanLy" && adminCtrls.Contains(ctrl))
        {
            <div class="col-lg-3 mb-4">
                <div class="card admin-sidebar">
                    <div class="card-header fw-bold">⚙️ Khu vực quản trị</div>
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action @Active("QuanLy")" href="/QuanLy">🏠 Bảng điều khiển</a>
                        <a class="list-group-item list-group-item-action @Active("DanhMuc")" href="/DanhMuc">📂 Quản lý danh mục</a>
                        <a class="list-group-item list-group-item-action @Active("SanPham")" href="/SanPham">📦 Quản lý sản phẩm</a>
                        <a class="list-group-item list-group-item-action @Active("QuanLyDonHang")" href="/QuanLyDonHang">🧾 Quản lý đơn hàng</a>
                        <a class="list-group-item list-group-item-action @Active("BinhLuan")" href="/BinhLuan">💬 Quản lý bình luận</a>
                        <a class="list-group-item list-group-item-action @Active("KhachHang")" href="/KhachHang">👤 Quản lý khách hàng</a>
                        <a class="list-group-item @Active("NguyenLieuQuanLy")" href="/NguyenLieuQuanLy">📦 Nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("NhapKho")" href="/NhapKho">📥 Nhập kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("TonKho")" href="/TonKho">📥 Quản lý tồn kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoThang">📊 Doanh thu theo tháng</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoNgay">📅 Doanh thu theo ngày</a>
                    </div>
                    <div class="card-body pt-0">
                        <a class="btn btn-sm btn-outline-secondary w-100" href="/">↩ Về trang khách</a>
                    </div>
                </div>
            </div>
        }
        <div class="col-lg-9">
            <h2 class="mb-4">💼 Quản lý khách hàng</h2>
            <div class="mb-4 d-flex gap-3 flex-wrap">
                <span class="badge bg-primary">Tổng khách hàng: @Model.Count()</span>
            </div>
            <form method="get" class="row g-3 mb-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text" name="search" class="form-control" value="@searchText" placeholder="Tên, Email, SDT..." />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
                </div>
            </form>

            <!-- Table khách hàng -->
            <form id="bulkForm">
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-hover align-middle bg-white mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAll" /></th>
                                <th>STT</th>
                                <th>Họ tên</th>
                                <th>Email</th>
                                <th>SDT</th>
                                <th>Điểm TL</th>
                                <th>Ngày tạo</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kh in Model.OrderByDescending(k => k.NgayTao))
                            {
                                <tr class="align-middle">
                                    <td><input type="checkbox" class="cbSelect" value="@kh.MaKH" /></td>
                                    <td>@kh.MaKH</td>
                                    <td>@kh.HoTen</td>
                                    <td>@kh.Email</td>
                                    <td>@(string.IsNullOrWhiteSpace(kh.SDT) ? "Chưa có" : kh.SDT)</td>
                                    <td><span class="badge bg-info text-dark">@kh.DiemTichLuy</span></td>
                                    <td>@kh.NgayTao.ToString("yyyy-MM-dd")</td>
                                    <td class="d-flex gap-1">
                                        <a href="@Url.Action("ChiTiet", "KhachHang", new { id = kh.MaKH })" class="btn btn-sm btn-info">Chi tiết</a>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="xoa(@kh.MaKH)">Xóa</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                    <select id="bulkAction" class="form-select w-auto">
                        <option value="">--Chọn hành động--</option>
                        <option value="Xoa">Xóa nhiều</option>
                    </select>
                    <button type="button" class="btn btn-primary" onclick="thucHienHanhDong()">Thực hiện</button>
                </div>
                <nav aria-label="Page navigation example" class="mt-3">
                    <ul class="pagination">
                        <li class="page-item"><a class="page-link" href="#">Trước</a></li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                    </ul>
                </nav>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $("#selectAll").on("change", function () {
            $(".cbSelect").prop("checked", this.checked);
        });
        function xoa(id) {
            if (!confirm("Bạn có chắc muốn xóa khách hàng này?")) return;
            $.post('@Url.Action("Xoa", "KhachHang")', { id: id })
                .done(r => { alert(r.message); if (r.success) location.reload(); })
                .fail(() => alert("Có lỗi xảy ra!"));
        }
        function thucHienHanhDong() {
            var action = $("#bulkAction").val();
            if (!action) { alert("Chọn hành động"); return; }
            var ids = $(".cbSelect:checked").map(function () { return parseInt($(this).val()); }).get();
            if (ids.length == 0) { alert("Chọn ít nhất 1 khách hàng"); return; }
            if (!confirm("Thực hiện '" + action + "' trên " + ids.length + " khách hàng?")) return;
            $.ajax({
                type: "POST",
                url: '@Url.Action("XoaNhieu", "KhachHang")',
                contentType: "application/json",
                data: JSON.stringify(ids),
                success: function (r) { alert(r.message); if (r.success) location.reload(); },
                error: function () { alert("Có lỗi xảy ra!"); }
            });
        }
    </script>
}
