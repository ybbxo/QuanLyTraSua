@model IEnumerable<WebTraSua.Models.BinhLuan>
@{
    ViewData["Title"] = "Quản lý bình luận";
    var role = Context.Session.GetString("Role");
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "");
    string Active(string c) => string.Equals(ctrl, c, StringComparison.OrdinalIgnoreCase) ? "active" : "";

    var trangThaiSelected = Context.Request.Query["trangThai"].ToString();
    var searchText = Context.Request.Query["search"].ToString();
    var adminCtrls = new HashSet<string> { "QuanLy", "DanhMuc", "SanPham", "QuanLyDonHang", "NguyenLieuQuanLy", "NhapKho", "ThongKe", "KhachHang", "BinhLuan" };
    var trangThaiOptions = new Dictionary<string, string>
    {
        {"", "Tất cả"},
        {"ChoDuyet", "Chờ duyệt"},
        {"Duyet", "Đã duyệt"},
        {"Huy", "Hủy"}
    };
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
<div class="container-fluid py-5">
    <div class="row">
@* ===== SIDEBAR QUẢN TRỊ ===== *@
@if (role == "QuanLy" && adminCtrls.Contains(ctrl))
{
            <div class="col-lg-3 mb-4">
                <div class="card admin-sidebar">
                    <div class="card-header fw-bold">⚙️ Khu vực quản trị</div>
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action @Active("QuanLy")" href="/QuanLy">🏠 Bảng điều khiển</a>
                        <a class="list-group-item list-group-item-action @Active("DanhMuc")" href="/DanhMuc">📂 Quản lý danh mục</a>
                        <a class="list-group-item list-group-item-action @Active("SanPham")" href="/SanPham">📦 Quản lý sản phẩm</a>
                        <a class="list-group-item list-group-item-action @Active("QuanLyDonHang")" href="/QuanLyDonHang">🧾 Quản lý đơn hàng</a>
                        <a class="list-group-item list-group-item-action @Active("BinhLuan")" href="/BinhLuan">💬 Quản lý bình luận</a>
                        <a class="list-group-item list-group-item-action @Active("KhachHang")" href="/KhachHang">👤 Quản lý khách hàng</a>
                        <a class="list-group-item @Active("NguyenLieuQuanLy")" href="/NguyenLieuQuanLy">📦 Nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("NhapKho")" href="/NhapKho">📥 Nhập kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoThang">📊 Doanh thu theo tháng</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoNgay">📅 Doanh thu theo ngày</a>
                    </div>
                    <div class="card-body pt-0">
                        <a class="btn btn-sm btn-outline-secondary w-100" href="/">↩ Về trang khách</a>
                    </div>
                </div>
            </div>
}
        <div class="col-lg-9">
            <h2 class="mb-4">Quản lý bình luận</h2>
            <div class="mb-4">
                <span class="badge bg-primary">Tổng: @Model.Count()</span>
                <span class="badge bg-success">Đã duyệt: @Model.Count(b => b.TrangThai == "Duyet")</span>
                <span class="badge bg-warning text-dark">Chờ duyệt: @Model.Count(b => b.TrangThai == "ChoDuyet")</span>
                <span class="badge bg-danger">Hủy: @Model.Count(b => b.TrangThai == "Huy")</span>
            </div>
            <form method="get" action="@Url.Action("TimKiem", "BinhLuan")" class="row g-3 mb-4 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-select" name="trangThai">
                        @foreach (var opt in trangThaiOptions)
                        {
                            if (trangThaiSelected == opt.Key)
                            {
                                <option value="@opt.Key" selected>@opt.Value</option>
                            }
                            else
                            {
                                <option value="@opt.Key">@opt.Value</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control" name="search" value="@searchText" placeholder="Tên người dùng, SP, nội dung..." />
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
                </div>
            </form>
            <div class="mb-3 d-flex gap-2 align-items-center">
                <select id="bulkAction" class="form-select w-auto">
                    <option value="">--Chọn hành động--</option>
                    <option value="Duyet">Duyệt nhiều</option>
                    <option value="Huy">Hủy nhiều</option>
                </select>
                <button type="button" class="btn btn-primary" onclick="thucHienHanhDongNhieu()">Thực hiện</button>
                <button type="button" class="btn btn-danger" onclick="xoaNhieu()">Xóa nhiều bình luận</button>
            </div>
            <form id="bulkForm">
                <div class="table-responsive shadow-sm rounded">
                    <table class="table table-hover align-middle bg-white mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="selectAll" /></th>
                                <th>SP</th>
                                <th>Người dùng</th>
                                <th>Nội dung</th>
                                <th>Sao</th>
                                <th>Ngày bình luận</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bl in Model.OrderByDescending(b => b.NgayBinhLuan))
                            {
                                <tr>
                                    <td><input type="checkbox" class="cbSelect" value="@bl.MaBL" /></td>
                                    <td>@(string.IsNullOrWhiteSpace(bl.SanPham?.TenSP) ? "Chưa xác định" : bl.SanPham.TenSP)</td>
                                    <td>@(string.IsNullOrWhiteSpace(bl.TenNguoiDung) ? "Chưa có" : bl.TenNguoiDung)</td>
                                    <td>@(string.IsNullOrWhiteSpace(bl.NoiDung) ? "Chưa có nội dung" : (bl.NoiDung.Length > 50 ? bl.NoiDung.Substring(0, 50) + "..." : bl.NoiDung))</td>
                                    <td>@bl.Sao</td>
                                    <td>@(bl.NgayBinhLuan.HasValue? bl.NgayBinhLuan.Value.ToString("dd/MM/yyyy HH:mm") : "N/A")</td>
                                    <td>
                                        <span class="badge @(bl.TrangThai == "Duyet" ? "bg-success" : bl.TrangThai == "ChoDuyet" ? "bg-warning text-dark" : bl.TrangThai == "Huy" ? "bg-danger" : "bg-secondary")">
                                            @(bl.TrangThai == "Duyet" ? "Đã duyệt" : bl.TrangThai == "ChoDuyet" ? "Chờ duyệt" : bl.TrangThai == "Huy" ? "Hủy" : "Chưa có")
                                        </span>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm" onchange="capNhatTrangThai(@bl.MaBL, this.value)">
                                            <option value="">--Cập nhật--</option>
                                            <option value="Duyet">Duyệt</option>
                                            <option value="Huy">Hủy</option>
                                        </select>
                                        <button type="button" class="btn btn-sm btn-danger mt-1 w-100" onclick="xoaBinhLuan(@bl.MaBL)">Xóa</button>
                                        @* Admin phan hoi *@
                                        <div class="mt-3">
                                            <label class="form-label">Phản hồi</label>
                                            <textarea class="form-control" rows="2" placeholder="Nhập phản hồi..." id="adminResponse-@bl.MaBL"></textarea>
                                            <button type="button" class="btn btn-sm btn-success mt-2 w-100" onclick="phatHoid(@bl.MaBL)">Gửi phản hồi</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
@section Scripts {
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script>
                $("#selectAll").on("change", function(){
                    $(".cbSelect").prop("checked", this.checked);
                });
                      function capNhatTrangThai(maBL, trangThaiMoi){
                        if(!trangThaiMoi) return;
                        var trangThaiText = trangThaiMoi === "Duyet" ? "Duyệt" : trangThaiMoi === "Huy" ? "Hủy" : trangThaiMoi;
                        $.post('@Url.Action("CapNhatTrangThai", "BinhLuan")', { MaBL: maBL, TrangThaiMoi: trangThaiMoi })
                        .done(r => {
                            alert(r.message.replace(trangThaiMoi, trangThaiText));
                            if(r.success) location.reload();
                        })
                        .fail(() => alert("Có lỗi xảy ra!"));
                    }
                function xoaBinhLuan(maBL){
                    if(!confirm("Bạn có chắc muốn xóa?")) return;
                    $.post('@Url.Action("Xoa", "BinhLuan")',{MaBL:maBL})
                    .done(r=>{ alert(r.message); if(r.success) location.reload(); })
                    .fail(()=>alert("Có lỗi xảy ra!"));
                }
                function xoaNhieu(){
                    var ids=[];
                    $(".cbSelect:checked").each(function(){ ids.push($(this).val()); });
                    if(ids.length==0){ alert("Chọn ít nhất 1 bình luận"); return; }
                    if(!confirm("Xóa "+ids.length+" bình luận?")) return;
                    var count = 0;
                    ids.forEach(function(id){
                        $.post('@Url.Action("Xoa", "BinhLuan")',{MaBL:id})
                        .done(function(){ count++; if(count===ids.length) { alert("Đã xóa các bình luận được chọn"); location.reload(); } });
                    });
                }
                           function thucHienHanhDongNhieu() {
                        var action = $("#bulkAction").val();
                        if (!action) { alert("Chọn hành động"); return; }
                        var actionText = action === "Duyet" ? "Duyệt" : action === "Huy" ? "Hủy" : action;
                        var ids = [];
                        $(".cbSelect:checked").each(function() { ids.push($(this).val()); });
                        if(ids.length === 0){ alert("Chọn ít nhất 1 bình luận"); return; }
                        if(!confirm("Thực hiện '" + actionText + "' trên " + ids.length + " bình luận?")) return;
                        var count = 0;
                        ids.forEach(function(id){
                            $.post('@Url.Action("CapNhatTrangThai", "BinhLuan")', { MaBL: id, TrangThaiMoi: action })
                            .done(function(){
                                count++;
                                if(count === ids.length){
                                    alert("Đã cập nhật trạng thái cho các bình luận được chọn");
                                    location.reload();
                                }
                            })
                            .fail(function(){ alert("Có lỗi xảy ra với bình luận id " + id); });
                        });
                    }
                              function phatHoid(maBL){
                    var responseContent = $("#adminResponse-" + maBL).val();
                    console.log(responseContent); 
                    if (!responseContent) {
                        alert("Vui lòng nhập phản hồi");
                        return;
                    }
                    $.post('@Url.Action("PhanHoi", "BinhLuan")', { MaBL: maBL, PhanHoi: responseContent })
                    .done(r => {
                        console.log(r);  
                        alert(r.message);
                        if (r.success) {
                            location.reload(); 
                        }
                    })
                    .fail((jqXHR, textStatus, errorThrown) => {
                        console.error("Request failed: ", textStatus, errorThrown);
                        alert("Có lỗi xảy ra khi gửi phản hồi");
                    });
                }
            </script>
}
