@model WebTraSua.Models.ThongKeDoanhThuTheoNgayViewModel
@using System.Globalization
@{
    ViewData["Title"] = "Thống kê doanh thu theo ngày";
    var vnCulture = new CultureInfo("vi-VN");

    var role = Context.Session.GetString("Role");
    var ctrl = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
    var adminCtrls = new HashSet<string> { "QuanLy", "DanhMuc", "SanPham", "QuanLyDonHang", "NguyenLieuQuanLy", "KhuyenMai", "NhapKho", "ThongKe","TonKho" };
    string Active(string controller, string action = null)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString() ?? "";
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString() ?? "";

        if (string.Equals(controller, currentController, StringComparison.OrdinalIgnoreCase))
        {
            if (string.IsNullOrEmpty(action) || string.Equals(action, currentAction, StringComparison.OrdinalIgnoreCase))
                return "active";
        }
        return "";
    }
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
    body {
        background: #f7f9fc;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .container-fluid {
        margin-top: 30px;
    }

    h2 {
        margin-bottom: 25px;
        color: #007bff;
    }

    .form-inline label {
        margin-right: 10px;
        font-weight: 600;
    }

    .form-inline input[type="date"] {
        margin-right: 15px;
        max-width: 180px;
    }

    .table thead {
        background-color: #007bff;
        color: white;
    }

    .total-row {
        background-color: #e9ecef;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .chart-container {
        margin-top: 40px;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .admin-sidebar {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 12px rgba(0,0,0,0.1);
        padding: 1rem;
        height: 100vh;
        position: sticky;
        top: 0;
    }

        .admin-sidebar .list-group-item.active {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            font-weight: 600;
        }

        .admin-sidebar .card-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 1rem;
        }
</style>

<div class="container-fluid">
    <div class="row">
        @if (role == "QuanLy" && adminCtrls.Contains(ctrl))
        {
            <div class="col-md-2">
                <div class="card admin-sidebar">
                    <div class="card-header">⚙️ Khu vực quản trị</div>
                    <div class="list-group list-group-flush">
                        <a href="/QuanLy" class="list-group-item list-group-item-action @Active("QuanLy")">🏠 Bảng điều khiển</a>
                        <a href="/DanhMuc/QuanLy" class="list-group-item list-group-item-action @Active("DanhMuc")">🗂 Quản lý danh mục</a>
                        <a href="/SanPham" class="list-group-item list-group-item-action @Active("SanPham")">🥤 Quản lý sản phẩm</a>
                        <a href="/QuanLyDonHang" class="list-group-item list-group-item-action @Active("QuanLyDonHang")">🧾 Quản lý đơn hàng</a>
                        <a href="/NguyenLieuQuanLy" class="list-group-item list-group-item-action @Active("NguyenLieuQuanLy")">📦 Nguyên liệu</a>
                        <a href="/NhapKho" class="list-group-item list-group-item-action @Active("NhapKho")">📥 Nhập kho</a>
                        <a href="/TonKho" class="list-group-item list-group-item-action @Active("TonKho")">📥 Quản lý tồn kho nguyên liệu</a>

                        <a href="/ThongKe/DoanhThuTheoNgay" class="list-group-item list-group-item-action @Active("ThongKe", "DoanhThuTheoNgay")">📊 Thống kê doanh thu theo ngày</a>
                        <a href="/ThongKe/DoanhThuTheoThang" class="list-group-item list-group-item-action @Active("ThongKe", "DoanhThuTheoThang")">📊 Thống kê doanh thu theo tháng</a>
                    </div>
                    <div class="mt-3">
                        <a href="/" class="btn btn-outline-secondary w-100">↩ Về trang khách</a>
                    </div>
                </div>
            </div>
        }
        <div class="@(role == "QuanLy" && adminCtrls.Contains(ctrl) ? "col-md-10" : "col-12")">
            <h2>📈 Doanh thu từ @Model.NgayBatDau.ToString("dd/MM/yyyy") đến @Model.NgayKetThuc.ToString("dd/MM/yyyy")</h2>
            <form method="get" class="form-inline mb-4 d-flex align-items-center">
                <label for="ngayBatDau">Ngày bắt đầu:</label>
                <input type="date" id="ngayBatDau" name="ngayBatDau" class="form-control"
                       value="@Model.NgayBatDau.ToString("yyyy-MM-dd")" required />
                <label for="ngayKetThuc">Ngày kết thúc:</label>
                <input type="date" id="ngayKetThuc" name="ngayKetThuc" class="form-control"
                       value="@Model.NgayKetThuc.ToString("yyyy-MM-dd")" required />
                <button type="submit" class="btn btn-primary ms-3">Xem</button>
            </form>
            <table class="table table-bordered table-striped shadow-sm">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Doanh thu (VNĐ)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.DoanhThuTheoNgay)
                    {
                        <tr>
                            <td>@item.Ngay.ToString("dd/MM/yyyy")</td>
                            <td>@item.DoanhThu.ToString("C0", vnCulture)</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>Tổng</td>
                        <td>@Model.TongDoanhThu.ToString("C0", vnCulture)</td>
                    </tr>
                </tfoot>
            </table>
            <div class="chart-container">
                <canvas id="doanhThuChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('doanhThuChart').getContext('2d');
    const labels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.DoanhThuTheoNgay.Select(x => x.Ngay.ToString("dd/MM"))));
    const data = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.DoanhThuTheoNgay.Select(x => x.DoanhThu)));
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: data,
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                        }
                    }
                }
            }
        }
    });
</script>