@model IEnumerable<WebTraSua.Models.DanhMucSanPham>
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Quản lý danh mục";
    var successMsg = TempData["Success"]?.ToString();
    var errorMsg = TempData["Error"]?.ToString();

    var role = Context.Session.GetString("Role");
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "");
    var adminCtrls = new HashSet<string> { "QuanLy", "DanhMuc", "SanPham", "QuanLyDonHang", "NguyenLieuQuanLy", "KhuyenMai", "NhapKho", "ThongKe", "TonKho" };
    string Active(string c) => string.Equals(ctrl, c, StringComparison.OrdinalIgnoreCase) ? "active" : "";
}
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        background: url('/images/hero_tra_sua.jpg') center center / cover no-repeat;
    }
    .admin-sidebar .list-group-item {
        border: 0;
        border-radius: 10px;
    }

        .admin-sidebar .list-group-item.active {
            background: #ffe7d6;
            color: #b35b36;
            font-weight: 700;
        }

    .admin-sidebar .card {
        border-radius: 14px;
        box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-4">
    <div class="row g-3">
        @if (role == "QuanLy" && adminCtrls.Contains(ctrl))
        {
            <div class="col-lg-3">
                <div class="card admin-sidebar position-sticky" style="top:84px">
                    <div class="card-header fw-bold">⚙️ Khu vực quản trị</div>
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action @Active("QuanLy")" href="/QuanLy">🏠 Bảng điều khiển</a>
                        <a class="list-group-item list-group-item-action @Active("DanhMuc")" href="/DanhMuc">📂 Quản lý danh mục</a>
                        <a class="list-group-item list-group-item-action @Active("SanPham")" href="/SanPham">📦 Quản lý sản phẩm</a>
                        <a class="list-group-item list-group-item-action @Active("QuanLyDonHang")" href="/QuanLyDonHang">🧾 Quản lý đơn hàng</a>
                        <a class="list-group-item list-group-item-action @Active("BinhLuan")" href="/BinhLuan">💬 Quản lý bình luận</a>
                        <a class="list-group-item list-group-item-action @Active("KhachHang")" href="/KhachHang">👤 Quản lý khách hàng</a>
                        <a class="list-group-item @Active("NguyenLieuQuanLy")" href="/NguyenLieuQuanLy">📦 Nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("NhapKho")" href="/NhapKho">📥 Nhập kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("TonKho")" href="/TonKho">📥 Quản lý tồn kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoThang">📊 Doanh thu theo tháng</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoNgay">📅 Doanh thu theo ngày</a>
                    </div>
                    <div class="card-body pt-0">
                        <a class="btn btn-sm btn-outline-secondary w-100" href="/">↩ Về trang khách</a>
                    </div>
                </div>
            </div>
        }

        <div class="col-lg-9">
            <div class="p-4 bg-white rounded shadow border">
                <h3 class="text-center mb-4">Quản lý danh mục</h3>

                @if (!string.IsNullOrEmpty(successMsg))
                {
                    <div class="alert alert-success text-center">@successMsg</div>
                }
                @if (!string.IsNullOrEmpty(errorMsg))
                {
                    <div class="alert alert-danger text-center">@errorMsg</div>
                    <script>
                        window.onload = () => {
                            var modal = new bootstrap.Modal(document.getElementById('addDanhMucModal'));
                            modal.show();
                        };
                    </script>
                }

                <div class="d-flex justify-content-between mb-3">
                    <a class="btn btn-outline-primary" href="/SanPham">➡️ Quản lý sản phẩm</a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDanhMucModal">+ Thêm mới</button>
                </div>

                <table class="table table-bordered">
                    <thead class="table-danger text-center">
                        <tr>
                            <th>Mã loại</th>
                            <th>Tên loại</th>
                            <th style="width:160px;">Công cụ</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@item.MaDM</td>
                                <td>@item.TenDM</td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm me-1" onclick="editDanhMuc(@item.MaDM, '@item.TenDM')">🖉 Sửa</button>
                                    <a class="btn btn-danger btn-sm" href="/DanhMuc/Delete/@item.MaDM" onclick="return confirm('Bạn chắc chắn muốn xóa?')">🗑️ Xóa</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addDanhMucModal" tabindex="-1" aria-labelledby="addDanhMucModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Create" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDanhMucModalLabel">➕ Thêm danh mục mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên danh mục</label>
                        <input name="TenDM" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="submit" class="btn btn-success">💾 Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editDanhMucModal" tabindex="-1" aria-labelledby="editDanhMucModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="Edit" method="post">
                <input type="hidden" name="MaDM" id="editMaDM" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editDanhMucModalLabel">🛠️ Sửa danh mục</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tên danh mục</label>
                        <input name="TenDM" id="editTenDM" class="form-control" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huỷ</button>
                    <button type="submit" class="btn btn-primary">💾 Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editDanhMuc(maDM, tenDM) {
        document.getElementById('editMaDM').value = maDM;
        document.getElementById('editTenDM').value = tenDM;
        var modal = new bootstrap.Modal(document.getElementById('editDanhMucModal'));
        modal.show();
    }
</script>