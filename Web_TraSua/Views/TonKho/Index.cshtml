@model List<WebTraSua.Controllers.TonKhoRowVM>
@using Microsoft.AspNetCore.Http
@using System
@using System.Collections.Generic

@{
    ViewData["Title"] = "Tồn kho nguyên liệu";
    // Ngưỡng cảnh báo tồn (tuỳ chỉnh)
    const decimal THRESHOLD = 100m;

    var totalItems = Model?.Count ?? 0;
    var totalQty = Model?.Sum(x => x.Ton) ?? 0;
    var lowCount = Model?.Count(x => x.Ton <= THRESHOLD) ?? 0;
    var dvts = Model?.Select(x => x.DVT).Distinct().OrderBy(x => x).ToList() ?? new List<string>();

    // Sidebar giống KhachHang/Index
    var role = Context.Session.GetString("Role");
    var ctrl = (ViewContext.RouteData.Values["controller"]?.ToString() ?? "");
    string Active(string c) => string.Equals(ctrl, c, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    var adminCtrls = new HashSet<string> {
        "QuanLy", "DanhMuc", "SanPham", "QuanLyDonHang", "NguyenLieuQuanLy",
        "NhapKho", "ThongKe", "KhachHang", "BinhLuan", "TonKho"
    };
}

<!-- Bootstrap Icons (giữ nếu layout chưa nạp) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<style>
    /* ———— Modern polish ———— */
    .page-title {
        font-weight: 700;
        letter-spacing: .2px;
    }

    .kpi-card {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    .kpi-value {
        font-size: 1.6rem;
        font-weight: 700;
        line-height: 1;
    }

    .kpi-label {
        color: #6c757d;
    }

    .toolbar .form-control, .toolbar .form-select {
        border-radius: .75rem;
    }

    .toolbar .btn {
        border-radius: .75rem;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
    }

    .table-hover tbody tr:hover {
        background: rgba(13,110,253,.06);
    }

    .status-badge {
        font-weight: 600;
        border-radius: 999px;
        padding: .3rem .65rem;
        font-size: .85rem;
    }

    /* Mobile: chuyển sang card-list */
    @@media (max-width: 767.98px) {
        .desktop-table

    {
        display: none;
    }

    .mobile-card {
        display: block;
    }

    }
    @@media (min-width: 768px) {
        .desktop-table

    {
        display: block;
    }

    .mobile-card {
        display: none;
    }

    }

    .stock-progress {
        height: .5rem;
        border-radius: 1rem;
        background: #e9ecef;
        overflow: hidden;
    }

        .stock-progress > div {
            height: 100%;
        }

        .stock-progress .ok {
            background: #198754;
        }

        .stock-progress .low {
            background: #fd7e14;
        }

        .stock-progress .out {
            background: #dc3545;
        }

    .card-elev {
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }

    /* Sidebar giống KhachHang */
    .admin-sidebar .list-group-item.active,
    .admin-sidebar .list-group-item.active:focus,
    .admin-sidebar .list-group-item.active:hover {
        background-color: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }
</style>

<div class="container my-4">
    <div class="row">
        <!-- Sidebar quản trị (giống KhachHang/Index) -->
        @if (role == "QuanLy" && adminCtrls.Contains(ctrl))
        {
            <div class="col-lg-3 mb-3">
                <div class="card admin-sidebar">
                    <div class="card-header fw-bold">⚙️ Khu vực quản trị</div>
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action @Active("QuanLy")" href="/QuanLy">🏠 Bảng điều khiển</a>
                        <a class="list-group-item list-group-item-action @Active("DanhMuc")" href="/DanhMuc">📂 Quản lý danh mục</a>
                        <a class="list-group-item list-group-item-action @Active("SanPham")" href="/SanPham">📦 Quản lý sản phẩm</a>
                        <a class="list-group-item list-group-item-action @Active("QuanLyDonHang")" href="/QuanLyDonHang">🧾 Quản lý đơn hàng</a>
                        <a class="list-group-item list-group-item-action @Active("BinhLuan")" href="/BinhLuan">💬 Quản lý bình luận</a>
                        <a class="list-group-item list-group-item-action @Active("KhachHang")" href="/KhachHang">👤 Quản lý khách hàng</a>
                        <a class="list-group-item list-group-item-action @Active("NguyenLieuQuanLy")" href="/NguyenLieuQuanLy">📦 Nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("NhapKho")" href="/NhapKho">📥 Nhập kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("TonKho")" href="/TonKho">📦 Tồn kho nguyên liệu</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoThang">📊 Doanh thu theo tháng</a>
                        <a class="list-group-item list-group-item-action @Active("ThongKe")" href="/ThongKe/DoanhThuTheoNgay">📅 Doanh thu theo ngày</a>
                    </div>
                    <div class="card-body pt-0">
                        <a class="btn btn-sm btn-outline-secondary w-100" href="/">↩ Về trang khách</a>
                    </div>
                </div>
            </div>
        }

        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="page-title mb-1">Tồn kho nguyên liệu</h2>
                    <div class="text-muted">Theo dõi số lượng hiện có & cảnh báo sắp hết</div>
                </div>
                <div class="d-none d-md-flex gap-2">
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> Tải lại
                    </a>
                    <button type="button" class="btn btn-primary" id="btnExport">
                        <i class="bi bi-download"></i> Export CSV
                    </button>
                </div>
            </div>

            <!-- KPI -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body d-flex align-items-center gap-3">
                            <div class="text-primary fs-3"><i class="bi bi-box-seam"></i></div>
                            <div>
                                <div class="kpi-value">@totalItems</div>
                                <div class="kpi-label">Mặt hàng</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body d-flex align-items-center gap-3">
                            <div class="text-success fs-3"><i class="bi bi-collection"></i></div>
                            <div>
                                <div class="kpi-value">@totalQty</div>
                                <div class="kpi-label">Tổng tồn</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <div class="card kpi-card">
                        <div class="card-body d-flex align-items-center gap-3">
                            <div class="text-warning fs-3"><i class="bi bi-exclamation-triangle"></i></div>
                            <div>
                                <div class="kpi-value">@lowCount</div>
                                <div class="kpi-label">Sắp hết (≤ @THRESHOLD)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="card card-elev mb-3">
                <div class="card-body toolbar">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-6">
                            <div class="input-group">
                                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                <input class="form-control" id="txtSearch" placeholder="Tìm mã, tên nguyên liệu hoặc đơn vị tính...">
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <select id="selDVT" class="form-select">
                                <option value="">Tất cả ĐVT</option>
                                @foreach (var d in dvts)
                                {
                                    <option value="@d">@d</option>
                                }
                            </select>
                        </div>
                        <div class="col-6 col-md-3 d-flex justify-content-end gap-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="chkLowOnly">
                                <label class="form-check-label" for="chkLowOnly">Chỉ hiển thị sắp hết</label>
                            </div>
                            <button class="btn btn-outline-secondary d-md-none" type="button" id="btnExportSm">
                                <i class="bi bi-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Table -->
            <div class="desktop-table">
                <div class="card card-elev">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table align-middle mb-0" id="grid">
                                <thead class="table-light">
                                    <tr>
                                        <th style="min-width:80px">Mã</th>
                                        <th style="min-width:260px">Nguyên liệu</th>
                                        <th style="min-width:100px">ĐVT</th>
                                        <th class="text-end" style="min-width:120px">Tồn</th>
                                        <th style="min-width:140px">Cập nhật</th>
                                        <th style="min-width:140px">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var r in Model)
                                    {
                                        var status = r.Ton <= 0 ? "Hết hàng" : (r.Ton <= THRESHOLD ? "Sắp hết" : "Còn hàng");
                                        var badge = r.Ton <= 0 ? "bg-danger" : (r.Ton <= THRESHOLD ? "bg-warning text-dark" : "bg-success");
                                        var pct = r.Ton <= 0 ? 0 : (r.Ton <= THRESHOLD ? Math.Min(100, (int)Math.Round((double)(r.Ton / THRESHOLD * 100))) : 100);
                                        var progCl = r.Ton <= 0 ? "out" : (r.Ton <= THRESHOLD ? "low" : "ok");
                                        <tr data-name="@(r.TenNL?.ToLower())" data-dvt="@(r.DVT?.ToLower())" data-ton="@r.Ton">
                                            <td>@r.MaNL</td>
                                            <td class="fw-semibold">@r.TenNL</td>
                                            <td>@r.DVT</td>
                                            <td class="text-end">
                                                <div>@r.Ton</div>
                                                <div class="stock-progress mt-1"><div class="@progCl" style="width:@pct%"></div></div>
                                            </td>
                                            <td>@(r.LastUpdated?.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
                                            <td><span class="status-badge @badge">@status</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Card List -->
            <div class="mobile-card">
                @foreach (var r in Model)
                {
                    var status = r.Ton <= 0 ? "Hết hàng" : (r.Ton <= THRESHOLD ? "Sắp hết" : "Còn hàng");
                    var badge = r.Ton <= 0 ? "bg-danger" : (r.Ton <= THRESHOLD ? "bg-warning text-dark" : "bg-success");
                    var pct = r.Ton <= 0 ? 0 : (r.Ton <= THRESHOLD ? Math.Min(100, (int)Math.Round((double)(r.Ton / THRESHOLD * 100))) : 100);
                    var progCl = r.Ton <= 0 ? "out" : (r.Ton <= THRESHOLD ? "low" : "ok");
                    <div class="card card-elev mb-2 item-card"
                         data-name="@(r.TenNL?.ToLower())" data-dvt="@(r.DVT?.ToLower())" data-ton="@r.Ton">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="fw-bold">@r.TenNL</div>
                                <span class="status-badge @badge">@status</span>
                            </div>
                            <div class="text-muted small">Mã: @r.MaNL · ĐVT: @r.DVT</div>
                            <div class="d-flex align-items-center justify-content-between mt-2">
                                <div class="me-3 w-100">
                                    <div class="d-flex justify-content-between small">
                                        <span>Tồn</span>
                                        <span class="fw-semibold">@r.Ton</span>
                                    </div>
                                    <div class="stock-progress mt-1"><div class="@progCl" style="width:@pct%"></div></div>
                                </div>
                                <div class="text-muted small ms-2" style="min-width:110px">@((r.LastUpdated?.ToString("dd/MM HH:mm")) ?? "-")</div>
                            </div>
                        </div>
                    </div>
                }
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script>
        (() => {
          const $q   = document.getElementById('txtSearch');
          const $dvt = document.getElementById('selDVT');
          const $low = document.getElementById('chkLowOnly');
          const $export = document.getElementById('btnExport');
          const $exportSm = document.getElementById('btnExportSm');

          const filter = () => {
            const q   = ($q?.value || '').trim().toLowerCase();
            const dvt = ($dvt?.value || '').toLowerCase();
            const low = $low?.checked;

            const rows = document.querySelectorAll('#grid tbody tr');
            rows.forEach(tr => {
              const name = (tr.getAttribute('data-name') || '');
              const dv   = (tr.getAttribute('data-dvt') || '');
              const ton  = parseFloat(tr.getAttribute('data-ton') || '0');

              let ok = true;
              if (q && !(name.includes(q) || dv.includes(q) || tr.children[0].textContent.toLowerCase().includes(q))) ok = false;
              if (dvt && dv !== dvt) ok = false;
              if (low && !(ton <= @THRESHOLD)) ok = false;

              tr.style.display = ok ? '' : 'none';
            });

            const cards = document.querySelectorAll('.mobile-card .item-card');
            cards.forEach(card => {
              const name = (card.getAttribute('data-name') || '');
              const dv   = (card.getAttribute('data-dvt') || '');
              const ton  = parseFloat(card.getAttribute('data-ton') || '0');

              let ok = true;
              if (q && !(name.includes(q) || dv.includes(q))) ok = false;
              if (dvt && dv !== dvt) ok = false;
              if (low && !(ton <= @THRESHOLD)) ok = false;

              card.style.display = ok ? '' : 'none';
            });
          };

          $q?.addEventListener('input', filter);
          $dvt?.addEventListener('change', filter);
          $low?.addEventListener('change', filter);

          const exportCSV = () => {
            const rows = Array.from(document.querySelectorAll('#grid tbody tr'))
              .filter(tr => tr.style.display !== 'none')
              .map(tr => {
                const tds = tr.querySelectorAll('td');
                const ma  = tds[0].textContent.trim();
                const ten = tds[1].textContent.trim().replaceAll(',', ' ');
                const dvt = tds[2].textContent.trim();
                const ton = tds[3].querySelector('div').textContent.trim();
                const capnhat = tds[4].textContent.trim();
                const trangthai = tds[5].textContent.trim();
                return [ma, ten, dvt, ton, capnhat, trangthai];
              });

            const header = ['MaNL','TenNL','DonViTinh','Ton','LastUpdated','TrangThai'];
            const csv = [header, ...rows].map(r => r.join(',')).join('\n');

            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url  = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'ton_kho.csv';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
          };

          $export?.addEventListener('click', exportCSV);
          $exportSm?.addEventListener('click', exportCSV);
        })();
    </script>
}
